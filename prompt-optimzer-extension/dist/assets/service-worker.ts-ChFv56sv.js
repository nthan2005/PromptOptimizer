console.log("[SW] Service Worker initialized");let r=!1;async function s(){if(!r)try{await chrome.offscreen.createDocument({url:chrome.runtime.getURL("src/offscreen/offscreen.html"),reasons:[chrome.offscreen.Reason.LOCAL_STORAGE],justification:"Run BM25F retrieval and template processing engine"}),r=!0,console.log("[SW] Offscreen document created")}catch(e){if(e instanceof Error&&e.message.includes("Only a single offscreen"))r=!0,console.log("[SW] Offscreen document already exists");else throw console.error("[SW] Failed to create offscreen document:",e),e}}chrome.runtime.onMessage.addListener((e,n,o)=>(console.log("[SW] Received message:",e.type,"from",n.tab?.id||"popup"),e.type==="PING"?(o({type:"PONG",id:e.id,timestamp:Date.now(),payload:{status:"ok"}}),!1):e.type==="OPTIMIZE_REQUEST"?(i(e).then(o).catch(t=>{console.error("[SW] Error handling optimize request:",t),o({type:"ERROR",id:e.id,timestamp:Date.now(),payload:{error:t.message}})}),!0):!1));async function i(e){console.log("[SW] Handling optimize request"),await s();const n=await chrome.runtime.sendMessage(e);return console.log("[SW] Received response from offscreen"),n}chrome.runtime.onInstalled.addListener(async e=>{console.log("[SW] Extension installed/updated:",e.reason),e.reason==="install"&&console.log("[SW] First install - will seed data in future weeks")});self.addEventListener("activate",e=>{console.log("[SW] Service worker activated")});
